<%- include("partials/header", { bot, user, path, title: "Cactie Music Player" }) %>

<div class="item">
  <h1>Playing Now</h1>
  <br>
  <h4 id="vcname">#Voice Channel</h4>  
</div>

<div class="musiccontainer">
  <div class="item musicsegment">
    <div class="item">
      <img src="/assets/images/musicplaceholder.png" width="55%" id="cover">
    </div>
  </div>
  <div class="item musicsegment">
    <div class="item">
      <h1 id="title">Music Title</h1>
      <br>
      <h4 id="author">Music Author</h4>
      <br>
      <div class="centered disabled" id="progresscontainer">
        <h5 id="pos" style="padding:15px; margin:0;">0:00</h5>
          <input type="range" disabled id="progress" oninput="progress();" value="0" style="width: 50%;">
        <h5 id="total" style="padding:15px; margin:0;">0:00</h5>
      </div>
      <div class="centered">
        <a href="/music/filters" class="mediacontrols" id="filters"><img src="/assets/icons/sliders.svg"></a>
        <a href="javascript:shuffle();" class="mediacontrols disabled" id="shuffle"><img src="/assets/icons/shuffle.svg"></a>
        <a href="javascript:toggleplay();" class="mediacontrols disabled" id="playbtn"><img id="play" src="/assets/icons/play.svg"></a>
        <a href="javascript:skip();" class="mediacontrols disabled" id="skip"><img src="/assets/icons/skip-forward.svg"></a>
      </div>      
      <div class="centered disabled" id="volumecontainer">
        <img style="padding:15px; margin:0;" src="/assets/icons/volume-x.svg">
          <input type="range" disabled id="volume" oninput="vol();" style="width:40%;" max=150>
        <img style="padding:15px; margin:0;" src="/assets/icons/volume-2.svg">
      </div>
      <h5 class="centered disabled" id="dj">Users without the DJ role have limited access.</h5>
    </div>
  </div>
</div>

<script>

  function convert(duration) {
    let seconds = parseInt((duration / 1000) % 60);
    let minutes = parseInt((duration / (1000 * 60)) % 60);
    const hours = parseInt((duration / (1000 * 60 * 60)) % 24);
    seconds = (seconds < 10) ? '0' + seconds : seconds;
    if (duration < 3600000) {
      return minutes + ':' + seconds;
    }
    else {
      minutes = (minutes < 10) ? '0' + minutes : minutes;
      return hours + ':' + minutes + ':' + seconds;
    }
  }

  function progress() {
    document.getElementById('pos').innerText = convert(document.getElementById('progress').value);
    document.getElementById('total').innerText = convert(document.getElementById('progress').max - document.getElementById('progress').value);
  }

  const ws = new WebSocket('<%= wsurl %>?id=<%= user.id %>');

  ws.onmessage = function(data) {
    const json = JSON.parse(data.data);
    if (json.type == 'error') return alert(json.message);
    
    if (json.type == 'info') {
      const { player } = json;
      document.getElementById('vcname').innerText = player.voiceChannel;
      document.getElementById('volume').value = player.volume;
      if (!player.paused) play.src = '/assets/icons/pause.svg';
      else play.src = '/assets/icons/play.svg';
      if (player.hasdj) {
        document.getElementById('dj').style.display = 'none';
        document.getElementById('volume').disabled = false;
        document.getElementById('volumecontainer').classList.remove('disabled');
        document.getElementById('progress').disabled = false;
        document.getElementById('progresscontainer').classList.remove('disabled');
        document.getElementById('shuffle').classList.remove('disabled');
        document.getElementById('playbtn').classList.remove('disabled');
        document.getElementById('skip').classList.remove('disabled');
      }
    }

    if (json.type == 'track') {
      document.getElementById('title').innerText = json.current.title.split('\n')[0];
      document.getElementById('author').innerText = json.current.title.split('\n')[1];
      document.getElementById('cover').src = json.current.img;
    }

    if (json.type == 'progress') {
      document.getElementById('progress').max = json.max;
      document.getElementById('progress').value = json.pos;
      document.getElementById('pos').innerText = convert(document.getElementById('progress').value);
      document.getElementById('total').innerText = convert(document.getElementById('progress').max - document.getElementById('progress').value);
    }
  }

</script>

<%- include("partials/footer") %>