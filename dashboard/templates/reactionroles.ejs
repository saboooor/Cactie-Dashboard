<%- include("partials/header", { bot, user, path, title: `General | ${guild.name}` }) %>
<%
settings.forEach(async reactionrole => {
  reactionrole.roleName = guild.roles.cache.get(reactionrole.roleId) ? guild.roles.cache.get(reactionrole.roleId).name : 'Could not get role.';
})
%>

<section class="hero is-fullheight-with-navbar is-dark">
  <div class="hero-body">
    <div class="container">
      <% if (alert) { %>
        <div class="notification is-success">
          <%= alert %>
        </div>
      <% } %>
        <div class="level">
          <div class="level-item">
            <figure class="image is-128x128" style="margin-right: px;">
              <img class="is-rounded" src="<%= guild.icon ? `https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}` : '/assets/images/placeholder.svg' %>">
            </figure>
          </div>
          <div class="level-item">
            <p class="title">
              <%= guild.name %>
            </p>
          </div>
          <div class="level-item">
            <div class="field is-grouped">
              <div class="control">
                <a href="/dashboard" class="button is-dark">Go Back</a>
              </div>
            </div>
          </div>
        </div>
        <div class="tabs is-toggle is-toggle-rounded is-fullwidth is-large">
          <ul>
            <li>
              <a href='/dashboard/<%= guild.id %>/general'>
                General
              </a>
            </li>
            <li>
              <a href='/dashboard/<%= guild.id %>/tickets'>
                Tickets
              </a>
            </li>
            <li>
              <a href='/dashboard/<%= guild.id %>/logs'>
                Logs
              </a>
            </li>
            <li class="is-active">
              <a>
                Reaction Roles
              </a>
            </li>
            <li>
              <a href='/dashboard/<%= guild.id %>/admin'>
                Admin
              </a>
            </li>
          </ul>
        </div>

        <br>
        <p class="subtitle">Current Reaction Roles</p> 
        <% settings.forEach(reactionrole => { %>
          <article class="media">
            <figure class="media-left">
              <% if (!isNaN(reactionrole.emojiId)) { %>
                <p class="image is-64x64">
                  <img src="https://cdn.discordapp.com/emojis/<%= reactionrole.emojiId %>.webp">
                </p>
              <% } else { %>
                <p class="is-size-1">
                  <%= reactionrole.emojiId %>
                </p>
              <% } %>
            </figure>
            <div class="media-content">
              <div class="content">
                <p>
                  <strong>@ <%= reactionrole.roleName %> (<%= reactionrole.type %>)</strong>
                  <br>
                  <% if (!reactionrole.message) { %>
                    Message deleted. Delete this reaction role and create another.
                  <% } else { %>
                    <strong>Message by <%= reactionrole.message.author.tag %>:</strong>
                    <br>
                    <p style="white-space: pre-line">
                      <%= reactionrole.message.content %>
                    </p>
                  <% } %>
                </p>
              </div>
              <nav class="level is-mobile">
                <div class="level-left">
                  <a class="level-item">
                    <span class="icon is-small"><i class="fas fa-reply"></i></span>
                  </a>
                  <a class="level-item">
                    <span class="icon is-small"><i class="fas fa-retweet"></i></span>
                  </a>
                  <a class="level-item">
                    <span class="icon is-small"><i class="fas fa-heart"></i></span>
                  </a>
                </div>
              </nav>
            </div>
            <% if (reactionrole.message) { %>
              <div class="media-right">
                <a class="button is-primary" href="<%= reactionrole.message.url %>">Go to message</a>
              </div>
            <% } %>
            <div class="media-right">
              <form action="/reactionroles/<%= reactionrole.guildId %>/delete" method="post">
                <button type="submit" name="id" value="<%= settings.indexOf(reactionrole) %>" class="button is-danger">Delete</button>
              </form>
            </div>
          </article>
        <% }) %>
      
      <br>
      <p class="subtitle">Create a new Reaction Role</p>
      <form name="add" onsubmit="return validateForm()" method="post">
        <div class="field">
          <label class="label">The role to use</label>
          <div class="select">
            <select name="role" placeholder="The role to use for the reaction role">
              <option value="0" selected>Select the role</option>
              <% guild.roles.cache.forEach(role => { %>
                <option value="<%= role.id %>"> <%= `@ ${role.name}` %></option>
              <% }) %>
            </select>
          </div>
        </div>
        <div class="field">
          <label class="label">The channel of the reaction role message</label>
          <div class="select">
            <select name="channel" placeholder="The channel to use for the reaction role">
              <option value="0" selected>Select the channel</option>
              <% guild.channels.cache.forEach(channel => { %>
                <% if (channel.type != Djs.ChannelType.GuildText && channel.type != Djs.ChannelType.GuildVoice) return %>
                <option value="<%= channel.id %>" <% if (channel.id === settings.suggestionchannel) {%> selected <%} else {%> <% } %> > <%= `${channel.type == Djs.ChannelType.GuildVoice ? 'ðŸ”Š' : '#'} ${channel.name}` %></option>
              <% }) %>
            </select>
          </div>
        </div>
        <div class="field">
          <label class="label">The reaction role's message Id <a style="color: #5ea3e4; text-decoration: underline;" href="https://support.discord.com/hc/en-us/articles/206346498-Where-can-I-find-my-User-Server-Message-ID-">What's this?</a></label>
          <div class="control">
            <input class="input" name="message" value="" placeholder="Put the Id here" style="width: 200px;">
          </div>
        </div>
        <div class="field">
          <label class="label">The reaction's emoji</label>
          <div class="control">
            <input class="input" name="emoji" value="ðŸ˜€" readonly style="width: 200px;" onclick="togglePicker()">
          </div>
        </div>
        <div class="field is-grouped">
          <div class="control">
            <a href="/dashboard" class="button is-success">Add Reaction Role</a>
          </div>
        </div>
      </form>
      <emoji-picker style="display: none;"></emoji-picker>
    </div>
  </div>
</section>
<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
<script>
  const picker = document.querySelector('emoji-picker');
  fetch('/emojis/<%= guild.id %>').then(res => res.json()).then(emojis => {
    picker.customEmoji = emojis;
  });
  function togglePicker() {
    picker.style.display = picker.style.display == 'none' ? 'block' : 'none';
  }
  picker.addEventListener('emoji-click', event => {
    document.getElementsByName('emoji')[0].value = event.detail.unicode ?? event.detail.emoji.name;
  });
  function validateForm() {
    console.log('a')
    let i1 = document.forms["add"]["role"].value;
    let i2 = document.forms["add"]["channel"].value;
    let i3 = document.forms["add"]["message"].value;
  if (!i1 || !i2 || !i3) {
      alert("You must fill out every field!");
      return false;
    }
  }
</script>
<%- include("partials/footer") %>